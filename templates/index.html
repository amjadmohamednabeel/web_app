<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Engagement Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        /* Add some basic styles for the loading indicator */
        .loading {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            color: #000;
        }
        .error-message {
            display: none;
            color: red;
            text-align: center;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <div class="logo-container">
        <img src="/static/images/logo.png" alt="Logo" class="logo">
    </div>
    <h1 class="dashboard-title">Video Engagement Dashboard</h1>

    <!-- Loading and error handling -->
    <div class="loading" id="loadingIndicator">Loading...</div>
    <div class="error-message" id="errorMessage">Error loading data. Please try again later.</div>

    <div class="dashboard-container">
        <div class="chart-wrapper">
            <canvas id="lineChart" class="chart"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="barChart" class="chart"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="engagementChart" class="chart"></canvas>
        </div>
        <div class="chart-wrapper">
            <canvas id="dailyEngagementChart" class="chart"></canvas>
        </div>
        <div class="chart-wrapper full-width">
            <canvas id="dailyProductEngagementChart" class="chart"></canvas>
        </div>
    </div>

    <script>
        function parseTimestamp(timestamp) {
            return new Date(timestamp);
        }

        function getRandomColor(opacity = 1) {
            return `rgba(${Math.random() * 255}, ${Math.random() * 255}, ${Math.random() * 255}, ${opacity})`;
        }

        fetch('/api/data')
            .then(response => response.json())
            .then(data => {
                const videoPlayCounts = {};
                const dates = [];
                const engagementTimes = {};
                const dailyEngagement = {};
                const dailyProductEngagement = {};

                let previousEntry = null;

                data.forEach(row => {
                    const date = new Date(row.Timestamp).toLocaleDateString();
                    const video = row['Video Played'];
                    const timestamp = parseTimestamp(row.Timestamp);

                    if (!videoPlayCounts[video]) videoPlayCounts[video] = {};
                    if (!videoPlayCounts[video][date]) videoPlayCounts[video][date] = 0;
                    videoPlayCounts[video][date]++;
                    if (!dates.includes(date)) dates.push(date);

                    if (previousEntry) {
                        const timeDiff = (timestamp - parseTimestamp(previousEntry.Timestamp)) / 1000;
                        if (previousEntry['Video Played'] === "Home Page" && video.includes("RON")) {
                            const healthVideo = video.replace(".mp4", "");
                            if (!engagementTimes[healthVideo]) engagementTimes[healthVideo] = [];
                            engagementTimes[healthVideo].push(timeDiff);

                            if (!dailyProductEngagement[date]) dailyProductEngagement[date] = {};
                            if (!dailyProductEngagement[date][healthVideo]) dailyProductEngagement[date][healthVideo] = [];
                            dailyProductEngagement[date][healthVideo].push(timeDiff);

                            if (!dailyEngagement[date]) dailyEngagement[date] = [];
                            dailyEngagement[date].push(timeDiff);
                        }
                    }
                    previousEntry = row;
                });

                // Show charts after data is processed
                document.getElementById('loadingIndicator').style.display = 'none';

                // Line Chart: Video Plays Over Time
                const lineCtx = document.getElementById('lineChart').getContext('2d');
                new Chart(lineCtx, {
                    type: 'line',
                    data: {
                        labels: dates.sort(),
                        datasets: Object.keys(videoPlayCounts).map(video => ({
                            label: video,
                            data: dates.map(date => videoPlayCounts[video][date] || 0),
                            borderColor: getRandomColor(),
                            fill: false
                        }))
                    }
                });

                // Bar Chart: Total Plays Per Video
                const barCtx = document.getElementById('barChart').getContext('2d');
                new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(videoPlayCounts),
                        datasets: [
                            {
                                label: 'Total Plays',
                                data: Object.keys(videoPlayCounts).map(video =>
                                    Object.values(videoPlayCounts[video]).reduce((a, b) => a + b, 0)
                                ),
                                backgroundColor: Object.keys(videoPlayCounts).map(() => getRandomColor(0.7)),
                                borderColor: Object.keys(videoPlayCounts).map(() => getRandomColor()),
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: 'Total Plays Per Video' },
                        },
                    },
                });

                // Pie Chart: Engagement Times by Video
                const engagementCtx = document.getElementById('engagementChart').getContext('2d');
                new Chart(engagementCtx, {
                    type: 'pie',
                    data: {
                        labels: Object.keys(engagementTimes),
                        datasets: [
                            {
                                data: Object.keys(engagementTimes).map(video =>
                                    Math.round(engagementTimes[video].reduce((a, b) => a + b, 0))
                                ),
                                backgroundColor: Object.keys(engagementTimes).map(() => getRandomColor(0.7)),
                                borderColor: Object.keys(engagementTimes).map(() => getRandomColor(1)),
                                borderWidth: 1,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { position: 'top' },
                            title: { display: true, text: 'Engagement Times by Video (Seconds)' },
                        },
                    },
                });

                // Line Chart: Daily Engagement Times
                const dailyEngagementCtx = document.getElementById('dailyEngagementChart').getContext('2d');
                new Chart(dailyEngagementCtx, {
                    type: 'line',
                    data: {
                        labels: Object.keys(dailyEngagement).sort(),
                        datasets: [
                            {
                                label: 'Daily Engagement Time',
                                data: Object.keys(dailyEngagement)
                                    .sort()
                                    .map(date => dailyEngagement[date].reduce((a, b) => a + b, 0)),
                                borderColor: getRandomColor(),
                                fill: true,
                                backgroundColor: getRandomColor(0.2),
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: 'Total Daily Engagement Time (Seconds)' },
                        },
                        scales: {
                            y: { beginAtZero: true },
                        },
                    },
                });

                // Stacked Bar Chart: Daily Product Engagement Times
                const dailyProductEngagementCtx = document
                    .getElementById('dailyProductEngagementChart')
                    .getContext('2d');
                new Chart(dailyProductEngagementCtx, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(dailyProductEngagement).sort(),
                        datasets: Object.keys(engagementTimes).map(video => ({
                            label: video,
                            data: Object.keys(dailyProductEngagement)
                                .sort()
                                .map(date =>
                                    dailyProductEngagement[date][video]
                                        ? dailyProductEngagement[date][video].reduce((a, b) => a + b, 0)
                                        : 0
                                ),
                            backgroundColor: getRandomColor(0.7),
                            borderColor: getRandomColor(1),
                            borderWidth: 1,
                        })),
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: true },
                            title: { display: true, text: 'Daily Product Engagement Times (Seconds)' },
                        },
                        scales: {
                            x: { stacked: true },
                            y: { stacked: true, beginAtZero: true },
                        },
                    },
                });
            })
            .catch(error => {
                console.error('Error fetching data:', error);
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
            });
    </script>
</body>
</html>
